let m=[],y={};const f=[],k=document.getElementById("device-type"),u={url:"/admin/pos/assignDeviceInPos",keys:["device_ids"]};k&&k.value=="kitchen"&&(u.url="/admin/assignDeviceInKitchen",u.device_kitchen_id=null,u.keys=["device_ids","device_kitchen_id"],S());function S(){"Mine"in window?window.Mine.postMessage("device_id:"):(Swal.fire({text:'Sent: device_id: (not on apk so you will not get it back) will continue with "test_id" as id)',icon:"success",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}}),u.device_kitchen_id="test_id")}let e={};if(k&&k.value=="kitchen"){e={sticker_printer:{printer:null,status:0},order_printer:{printer:null,status:0},language:null};const t=document.querySelectorAll('input:not([name="_token"]):not([immune]), select:not([immune])');for(let a of t)a.setAttribute("disabled","disabled");let o=!1;const n=document.getElementsByClassName("edit-btn");for(let a of n)a.addEventListener("click",d=>{if(d.preventDefault(),d.stopPropagation(),o=!o,o)for(let r of t)r.removeAttribute("disabled");else{y=e,m=[];const r=document.getElementById("order_printer");if(r&&r.value!=""&&r.value!=" "&&r.value in window.printers){e.order_printer.printer=window.printers[r.value];let c=e.order_printer.printer.id;m.push(c),f.push({id:c,ip:e.order_printer.printer.ip,name:e.order_printer.printer.name,port:e.order_printer.printer.port,type:e.order_printer.type,prenonce:"order-"})}else e.order_printer.printer=null;const i=document.getElementById("order_printer_status");i&&"checked"in i&&i.checked?e.order_printer.status=1:e.order_printer.status=0;const l=document.getElementById("sticker_printer");if(l&&l.value!=""&&l.value!=" "&&l.value in window.printers){e.sticker_printer.printer=window.printers[l.value];let c=e.sticker_printer.printer.id;m.push(c),f.push({id:c,ip:e.sticker_printer.printer.ip,name:e.sticker_printer.printer.name,port:e.sticker_printer.printer.port,prenonce:"sticker-"})}else e.sticker_printer.printer=null;const p=document.getElementById("sticker_printer_status");p&&"checked"in p&&p.checked?e.sticker_printer.status=1:e.sticker_printer.status=0,localStorage.setItem("printer_settings",JSON.stringify(e)),v();for(let c of t)c.setAttribute("disabled","disabled")}for(let r of n){let i=r.querySelector(".text");i&&(i.textContent=o?i.getAttribute("active"):i.getAttribute("inactive"))}return!1})}else{e={receipt_printer:{printer:null,status:0},terminal:{terminal:null,status:0},language:null};const t=document.querySelectorAll('input:not([name="_token"]):not([immune]), select:not([immune])');for(let a of t)a.setAttribute("disabled","disabled");let o=!1;const n=document.getElementsByClassName("edit-btn");for(let a of n)a.addEventListener("click",d=>{if(d.preventDefault(),d.stopPropagation(),o=!o,o)for(let r of t)r.removeAttribute("disabled");else{y=e,m=[];const r=document.getElementById("receipt_printer");if(r&&r.value!=""&&r.value!=" "&&r.value in window.printers){e.receipt_printer.printer=window.printers[r.value];let c=e.receipt_printer.printer.id;m.push(c),f.push({id:c,ip:e.receipt_printer.printer.ip,name:e.receipt_printer.printer.name,port:e.receipt_printer.printer.port,prenonce:"order-"})}else e.receipt_printer.printer=null;const i=document.getElementById("receipt_printer_status");i&&"checked"in i&&i.checked?e.receipt_printer.status=1:e.receipt_printer.status=0;const l=document.getElementById("payment_terminal");if(l&&l.value!=""&&l.value!=" "){if(l.value==1)e.terminal.terminal={id:1,name:0,ip:1,port:"",type:"",compatibility_port:"",socket_mode:"",terminal_type:"",terminal_manual_payment:!0};else if(l.value in window.terminals){e.terminal.terminal=window.terminals[l.value];let h=e.terminal.terminal.id;m.push(h)}}else e.terminal.terminal=null;const p=document.getElementById("payment_terminal_status");p&&"checked"in p&&p.checked?e.terminal.status=1:e.terminal.status=0,localStorage.setItem("printer_settings",JSON.stringify(e));for(let c of t)c.removeAttribute("disabled");if(f.length==0){localStorage.removeItem("printer_settings"),B([]);return}v()}for(let r of n){let i=r.querySelector(".text");i&&(i.textContent=o?i.getAttribute("active"):i.getAttribute("inactive"))}return!1})}let s=localStorage.getItem("printer_settings");if(s!=null)try{if(s=JSON.parse(s),"receipt_printer"in s&&"printer"in s.receipt_printer){e.receipt_printer=s.receipt_printer;const t=document.getElementById("receipt_printer");e.receipt_printer.printer&&t&&(t.value=e.receipt_printer.printer.id,e.receipt_printer.status==1&&(document.getElementById("receipt_printer_status").checked=!0))}if("sticker_printer"in s&&"printer"in s.sticker_printer){e.sticker_printer=s.sticker_printer;const t=document.getElementById("sticker_printer");e.sticker_printer.printer&&t&&(t.value=e.sticker_printer.printer.id,e.sticker_printer.status==1&&(document.getElementById("sticker_printer_status").checked=!0))}if("order_printer"in s&&"printer"in s.order_printer){e.order_printer=s.order_printer;const t=document.getElementById("order_printer");e.order_printer.printer&&t&&(t.value=e.order_printer.printer.id,e.order_printer.status==1&&(document.getElementById("order_printer_status").checked=!0))}if("terminal"in s&&"terminal"in s.terminal){e.terminal=s.terminal;const t=document.getElementById("payment_terminal");e.receipt_printer.printer&&t&&(t.value=e.terminal.terminal.id,e.terminal.status==1&&(document.getElementById("payment_terminal_status").checked=!0))}"language"in s&&(e.language=s.language)}catch{}let w=!1,_={amountToCheck:0,currentChecked:0};setInterval(()=>{if(!w)return;if(f.length==0){w=!1;return}const t=f.shift();"Mine"in window&&window.Mine.postMessage(`con:${t.prenonce}${t.name}:${t.ip}:${t.port}`)},1e3);function v(){w=!0,_.currentChecked=0,_.amountToCheck=f.length}function b(){_.amountToCheck==_.currentChecked&&(Swal.fire({text:window.keys.printerConigurationConfirmed,icon:"success",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}}),B(m))}function B(t){const o={};u.device_ids=t;for(let n of u.keys)o[n]=u[n];$.ajax({method:"POST",url:u.url,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},dataType:"json",data:o,success:function(n){if(n.status==2){g(),location.href=n.redirect_uri;return}if(n.status==1){g(),Swal.fire({text:n.message,icon:"error",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}});return}if(n.status==0||n.status==4){const a=document.querySelectorAll('input:not([name="_token"]):not([immune]), select:not([immune])');for(let d of a)d.setAttribute("disabled","disabled")}else g();"message"in n&&n.message!=""&&Swal.fire({text:n.message,icon:"success",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn btn-primary"}})},error:function(n){g(),swal.fire({text:"An unexpected error occured",icon:"error",buttonsstyling:!1,confirmbuttontext:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}})}})}function g(){e=y,localStorage.setItem("printer_settings",JSON.stringify(e))}window.connected=t=>{_.currentChecked++,_.amountToCheck==_.currentChecked&&b()};window.failed_connection=(t,o,n)=>{n!=3?(Swal.fire({text:t+" "+window.keys.failedConnection,icon:"error",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}}),b()):(Swal.fire({text:t+" "+failedConnectionReason+": "+o,icon:"error",buttonsStyling:!1,confirmButtonText:window.keys.confirmButtonOk,customClass:{confirmButton:"btn fw-bold btn-primary"}}),b())};
